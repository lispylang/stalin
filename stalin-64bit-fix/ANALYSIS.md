# Stalin 64-bit Analysis Report

## Problem Root Cause

The existing `stalin.c` file (21MB) was generated by Stalin when using **IA32** architecture, which has:
- `*pointer-size*` = **4 bytes** (32-bit)
- `*pointer-alignment*` = **2**
- `*squished-size*` = **4 bytes**

This causes hard-coded assertions like:
```c
assert(offsetof(struct{char dummy; char *probe;}, probe)==4);
```

## Solution

Stalin ALREADY supports 64-bit architectures! The file `stalin.architectures` contains:

### AMD64 Architecture (lines 414-446)
- `*pointer-size*` = **8 bytes** ✅
- `*pointer-alignment*` = **3**
- `*squished-size*` = **8 bytes**

### Current Architecture Detection
```bash
$ bash include/stalin-architecture-name
AMD64  # Correct! ARM64 → AMD64 mapping works
```

## The Fix Strategy

1. **stalin.sc already generates correct code** based on `*pointer-size*` variable
2. Lines 20850-20862 in stalin.sc generate assertions:
   ```scheme
   (c:assert (c:== (c:sizeof (space-between "void" "*"))
                   (c:fixnum *pointer-size*)))
   ```
3. If `*pointer-size*` = 8, this generates: `assert(sizeof(void*) == 8);`

## What We Need to Do

**Regenerate stalin.c from stalin.sc using AMD64 architecture:**

1. Use Chez Scheme to compile stalin.sc
2. Ensure it loads AMD64 architecture (pointer-size = 8)
3. Generate new stalin.c with 64-bit assumptions
4. Compile new stalin.c → stalin-64bit binary
5. Test: stalin-64bit should work on ARM64, x86_64, and all 64-bit platforms

## Key Files

- `stalin.sc` (32,905 lines): Stalin compiler source
- `stalin.architectures`: Architecture definitions (AMD64 has pointer-size=8)
- `stalin-architecture-name`: Correctly returns "AMD64" for ARM64
- `QobiScheme.sc`: Required dependency for stalin.sc

## Architecture Parameters (AMD64)

```scheme
("AMD64"
  "char"          ;*char*
  "int"           ;*fixnum*
  "float"         ;*flonum* when float
  "double"        ;*flonum* when double
  "unsigned"      ;*length*
  "unsigned"      ;*tag*
  "unsigned long" ;*squished*
  "long"          ;*signed-squished*
  "FILE"          ;*file*
  "jmp_buf"       ;*jmpbuf*
  0               ;*char-alignment*
  2               ;*fixnum-alignment*
  2               ;*flonum-alignment* when float
  3               ;*flonum-alignment* when double
  3               ;*pointer-alignment*     ← 8-byte alignment (2^3)
  2               ;*length-alignment*
  2               ;*tag-alignment*
  3               ;*squished-alignment*
  3               ;*file-alignment*
  3               ;*jmpbuf-alignment*
  1               ;*char-size*
  4               ;*fixnum-size*
  4               ;*flonum-size* when float
  8               ;*flonum-size* when double
  8               ;*pointer-size*          ← 8 bytes! ✅
  4               ;*length-size*
  4               ;*tag-size*
  8               ;*squished-size*         ← 8 bytes! ✅
  #f)             ;*include-malloc-for-alloca?*
```

## Next Steps

1. Test QobiScheme.sc with Chez Scheme
2. Identify any Chez compatibility issues
3. Create minimal Stalin test
4. Compile stalin.sc → stalin.c with Chez
5. Verify new stalin.c has 64-bit assumptions
6. Compile stalin.c → stalin-64bit
7. Test stalin-64bit on simple programs

## Expected Outcome

Once we regenerate stalin.c with AMD64 architecture:
- Assertions will expect 8-byte pointers
- Structure layouts will be correct for 64-bit
- Stalin will work on ARM64, x86_64, and all 64-bit platforms
- C→APE pipeline will work end-to-end

## Confidence Level

**Very High (90%)** - Stalin already has all the 64-bit support code. We just need to regenerate stalin.c with the correct architecture.
